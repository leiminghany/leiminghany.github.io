# FeatureToggle特性开关



原文参考(https://martinfowler.com/bliki/FeatureToggle.html)



#### 特性开关

一个支持FeatureBranch最普遍的理由是它为不确定功能提供了一种机制，这种机制让单个发布流程更耗时。

想象下你每两周都要发布上线，但是需要构建一个将要耗费三个月才能完成的功能。使用持续集成，你怎样去保证工作在主干线上的每个人在发布中不出现未完成功能？我们深入这个问题一点，FeatureToggles是个好的工具来帮助解决它。

![img](https://martinfowler.com/bliki/images/featureToggle/featureToggle.png)

（我已经看到很多这个概念的名字被抛出：特征位，标志，鳍状肢，开关等。 似乎还没有普遍接受的名字。）


我写完此博文之后，我的同事Pete Hodgson写了一个关于如何使用[Feature Toggles的详细的文章](https://martinfowler.com/articles/feature-toggles.html)。它详细的介绍了不同类型的toggles和管理toggles的多种方式，以及toggle的配置、使用建议。


其基本的思想是要有一个配置文件，其中定义了很多不确定功能一系列开关。然后运行程序使用这些开关来决定是否需要显示对应的新功能。

大多数开关出现在应用程序的用户页面，所以如果你在构建一个Jsp web应用。你可以使用一系列jsp标签来包围任何不确定的用户接口部分。

```jsp
<toggle name="petSurvey">
      <p>Take our new <a href = 'petSurvey'>pet survey</a></p>
</toggle>
```



toggle标签的实现正是如果toggle设置为开时则传输里面的内容，否则将跳过。其他UI技术会使用不同的细节，但是包装待处理元素的基本概念是相同的。

某些功能可能类似于引入新的定价算法，其中可能没有用户界面元素。 这样，Toggle的测试将在应用程序代码中，它可以像条件测试那样粗糙，或者像依赖注入策略那样更复杂。

Toogle测试应仅出现在最小量的开关处，以确保正确隐藏新功能。 可能有许多屏幕含有‘宠物调查功能’，但如果只有主页的一个链接让您访问到它，那么这是唯一需要使用toggle标签保护的元素。 不要尝试使用toggle来保护新功能代码中的每个代码路径，只关注那些会引导用户访问的入口点并设置这些切入点的开关。 如果您发现创建，维护或删除切换需要很长时间，那么这表明您有太多的toggle测试。 请记住，尽管简单条件是实现切换的最简单方法，但您应该使用多态替换等技术来最小化toggle测试点的数量。

到目前为止，我已经描述feature toggle为用于隐藏部分构建功能的技术，一种我称之为发布选项的特性开关。 Hodgson还指出了用于A / B测试的实验开关，为操作人员提供控制的操作开关，以及为控制不同用户子集访问控制的权限开关。 （这篇文章的旧版本里把所有这些都归为“业务开关”）

我听说过的大多数特性开关都是在运行时设置的，但我也看到了在构建时设置了发布开关的情况。 构建开关的一个小优点是，新功能的代码都没有编译到已发布的可执行文件中。

当有人忘记将UI功能包装在toggle标签中时，功能开关的一个危险是意外曝光。 这很难测试，在不调用出特定元素的情况下，没有隐藏的内容都是可见的，然后调用特定元素在那时也容易被遗忘。

我们听到一个关于特性开关相关测试的常见问题 - 使用特性开关是否意味着测试的组合爆炸？ 通常，不需要测试所有功能组合。 对于发布开关，通常运行两种组合就足够了。

- all the toggles on that are expected to be on in the next release
- all toggles on

如果要查找任何集成错误，这与FeatureBranch模式所需的功能几乎相同。

一旦不确定特性在生产中敲定，下限特性开关非常重要。 这涉及删除配置文件上的定义以及使用它们的所有代码。 否则你会得到一堆没人能记住如何使用的开关。 在我听说的一个令人难忘的例子中，它需要对linux内核进行特殊的重新编译以处理足够的命令行开关。

#### 发布开关是你应该做的最后一件事

发布开关一种有用的技术，很多团队都使用它们。 但是，当您处理将功能投入生产时，它们应该是您的最后选择。

您的首选应该是分解功能，以便您可以安全地将部分功能引入产品中。 这样做的优点与任何基于小型、频繁发布的策略相同。 您可以降低出错的风险，并获得有关用户如何实际使用该功能的宝贵反馈，从而改善您以后所做的升级功能。

如果你真的必须隐藏部分构建的功能，那么最好的方法是构建除UI入口点之外的所有功能，并在单个发布周期中添加该UI。 这样，非ui代码与其他所有内容完全集成，但在你添加最后代码之前，没有任何内容可见或可使用。 这种方法的问题在于，在最终发布周期，即功能上线之前，您无法进行任何需要UI的测试，例如通过UI进行BroadStackTests，或者更重要的是，使用UI进行探索性测试。 您可以（并且应该）仍然使用其他测试，例如皮下测试或可能是UI的后门。

只有当你不能完成小版本或UI时，你应该启用发布开关。

#### 扩展阅读

想了解feature toggles更细节的图片和使用方法，请参考 [Pete Hodgson's article](https://martinfowler.com/articles/feature-toggles.html)

#### 致谢

(Thanks to Charles Bradley, Kent Beck and Christian Gruber for tweets that reminded me of points I forgot to include.)

#### 修订

Updated 2016-02-12 to fit in with Pete Hodgson's detailed article